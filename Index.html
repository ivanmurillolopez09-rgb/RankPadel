<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="RankPadel - Sistema de ranking para comunidades de p√°del">
    <meta name="theme-color" content="#667eea">
    <title>RankPadel - Comunidad Vecinal</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUmFua1BhZGVsIiwic2hvcnRfbmFtZSI6IlJhbmtQYWRlbCIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjNjY3ZWVhIiwidGhlbWVfY29sb3IiOiIjNjY3ZWVhIn0=">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .glass-dark {
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(10px);
        }

        .rank-bronze { background: linear-gradient(135deg, #cd7f32 0%, #e8a87c 100%); }
        .rank-silver { background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); }
        .rank-gold { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); }
        .rank-platinum { background: linear-gradient(135deg, #e5e4e2 0%, #f0f0f0 100%); }
        .rank-diamond { background: linear-gradient(135deg, #b9f2ff 0%, #00bfff 100%); }
        .rank-legend { background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); }

        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .tab-active {
            color: #667eea;
            position: relative;
        }

        .tab-active::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: #667eea;
            border-radius: 50%;
        }

        .hidden-section {
            display: none;
        }

        .match-card {
            transition: all 0.3s ease;
        }

        .match-card:hover {
            transform: translateX(5px);
        }

        .level-badge {
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 3px;
        }

        .loading-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        .loading-hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
<base target="_blank">
</head>
<body class="text-gray-800">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <h1 class="text-2xl font-bold text-white">RankPadel</h1>
            <p class="text-white/80 text-sm">Cargando...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500"></div>
        <div class="absolute inset-0 opacity-30">
            <div class="absolute top-20 left-10 w-32 h-32 bg-white rounded-full mix-blend-overlay filter blur-xl animate-float"></div>
            <div class="absolute bottom-20 right-10 w-40 h-40 bg-yellow-300 rounded-full mix-blend-overlay filter blur-xl animate-float" style="animation-delay: 2s;"></div>
        </div>

        <div class="glass rounded-3xl p-8 w-full max-w-md relative z-10 shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">
                    <i data-lucide="trophy" class="w-10 h-10 text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">RankPadel</h1>
                <p class="text-gray-500">Tu comunidad deportiva vecinal</p>
            </div>

            <div id="loginForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="loginEmail" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all" placeholder="tu@email.com" autocomplete="email">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label>
                        <input type="password" id="loginPassword" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
                    </div>
                    <button onclick="handleLogin()" class="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-semibold shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all">
                        Iniciar Sesi√≥n
                    </button>
                </div>

                <div class="mt-6 text-center">
                    <p class="text-gray-500 text-sm">¬øNo tienes cuenta?</p>
                    <button onclick="showRegister()" class="text-indigo-600 font-semibold hover:underline mt-1">Reg√≠strate aqu√≠</button>
                </div>
            </div>

            <div id="registerForm" class="hidden">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre completo</label>
                        <input type="text" id="regName" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all" placeholder="Tu nombre" autocomplete="name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="regEmail" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all" placeholder="tu@email.com" autocomplete="email">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label>
                        <input type="password" id="regPassword" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password">
                    </div>
                    <button onclick="handleRegister()" class="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-semibold shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all">
                        Crear Cuenta
                    </button>
                </div>

                <div class="mt-6 text-center">
                    <button onclick="showLogin()" class="text-gray-500 text-sm hover:text-indigo-600">‚Üê Volver al login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden min-h-screen pb-20">
        <!-- Header -->
        <header class="glass sticky top-0 z-40 px-4 py-3 shadow-sm">
            <div class="max-w-lg mx-auto flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                        <i data-lucide="trophy" class="w-4 h-4 text-white"></i>
                    </div>
                    <span class="font-bold text-lg text-gray-800">RankPadel</span>
                </div>
                <button onclick="logout()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <i data-lucide="log-out" class="w-5 h-5 text-gray-600"></i>
                </button>
            </div>
        </header>

        <!-- Content Container -->
        <div class="max-w-lg mx-auto px-4 py-6">

            <!-- HOME/RANKING SECTION -->
            <section id="rankingSection" class="slide-up">
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="crown" class="w-5 h-5 text-yellow-300"></i>
                        Ranking Top
                    </h2>
                    <div id="podiumContainer" class="flex items-end justify-center gap-4 mb-6">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>

                <div class="glass rounded-2xl p-4 shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-gray-800">Clasificaci√≥n General</h3>
                        <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full" id="totalPlayers">0 jugadores</span>
                    </div>
                    <div id="rankingList" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </section>

            <!-- PROFILE SECTION -->
            <section id="profileSection" class="hidden-section slide-up">
                <div class="glass rounded-3xl p-6 shadow-xl mb-6">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="relative">
                            <div id="profileLevelBadge" class="w-20 h-20 rounded-2xl flex items-center justify-center text-2xl font-bold text-white shadow-lg level-badge">
                                V
                            </div>
                            <div class="absolute -bottom-2 -right-2 w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-md">
                                <i data-lucide="trending-up" class="w-4 h-4 text-green-500"></i>
                            </div>
                        </div>
                        <div class="flex-1">
                            <h2 id="profileName" class="text-2xl font-bold text-gray-800">Usuario</h2>
                            <p id="profileLevel" class="text-indigo-600 font-semibold">Nivel Vecino</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span id="profilePoints" class="text-2xl font-bold text-gray-800">1500</span>
                                <span class="text-sm text-gray-500">puntos</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="text-center p-3 bg-gray-50 rounded-xl">
                            <div id="statPlayed" class="text-xl font-bold text-gray-800">0</div>
                            <div class="text-xs text-gray-500">Jugados</div>
                        </div>
                        <div class="text-center p-3 bg-green-50 rounded-xl">
                            <div id="statWon" class="text-xl font-bold text-green-600">0</div>
                            <div class="text-xs text-gray-500">Ganados</div>
                        </div>
                        <div class="text-center p-3 bg-red-50 rounded-xl">
                            <div id="statLost" class="text-xl font-bold text-red-600">0</div>
                            <div class="text-xs text-gray-500">Perdidos</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">Win Rate</span>
                            <span id="winRate" class="font-bold text-indigo-600">0%</span>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div id="winRateBar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">Progreso al siguiente nivel</span>
                            <span id="nextLevelProgress" class="font-bold text-gray-800">0%</span>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div id="levelProgressBar" class="h-full bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <p id="nextLevelText" class="text-xs text-gray-500 mt-1 text-center">150 puntos para Bronce</p>
                    </div>
                </div>

                <div class="glass rounded-2xl p-4 shadow-lg">
                    <h3 class="font-bold text-gray-800 mb-4">√öltimos Partidos</h3>
                    <div id="recentMatches" class="space-y-3">
                        <p class="text-gray-500 text-center py-4">No hay partidos registrados</p>
                    </div>
                </div>
            </section>

            <!-- ADD MATCH SECTION -->
            <section id="addMatchSection" class="hidden-section slide-up">
                <div class="glass rounded-3xl p-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <i data-lucide="plus-circle" class="w-6 h-6 text-indigo-600"></i>
                        Registrar Partido de P√°del
                    </h2>

                    <!-- Step 2: Team Selection -->
                    <div id="step2" class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Configuraci√≥n de Equipos</label>

                        <!-- Your Team -->
                        <div class="mb-4">
                            <p class="text-xs font-semibold text-indigo-600 mb-2 uppercase tracking-wide">Tu Equipo</p>
                            <div class="bg-indigo-50 rounded-xl p-3 border-2 border-indigo-200">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-white text-xs font-bold">
                                        Yo
                                    </div>
                                    <span class="font-medium text-sm" id="currentUserName">T√∫</span>
                                    <span class="text-xs text-gray-500" id="currentUserPoints">(1500 pts)</span>
                                </div>
                                <select id="partnerSelect" class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm focus:border-indigo-500 outline-none bg-white">
                                    <option value="">Selecciona tu compa√±ero...</option>
                                </select>
                            </div>
                        </div>

                        <!-- VS Divider -->
                        <div class="flex items-center justify-center my-4">
                            <div class="h-px bg-gray-300 flex-1"></div>
                            <span class="px-3 text-gray-400 font-bold text-sm">VS</span>
                            <div class="h-px bg-gray-300 flex-1"></div>
                        </div>

                        <!-- Opponent Team -->
                        <div>
                            <p class="text-xs font-semibold text-red-600 mb-2 uppercase tracking-wide">Equipo Rival</p>
                            <div class="bg-red-50 rounded-xl p-3 border-2 border-red-200 space-y-2">
                                <select id="opponent1Select" class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm focus:border-red-500 outline-none bg-white">
                                    <option value="">Rival 1...</option>
                                </select>
                                <select id="opponent2Select" class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm focus:border-red-500 outline-none bg-white">
                                    <option value="">Rival 2...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Score -->
                    <div id="step3" class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Resultado (sets)</label>
                        <div class="flex items-center gap-4">
                            <div class="flex-1 text-center">
                                <div class="bg-indigo-100 rounded-xl p-3 mb-1">
                                    <span class="text-xs text-indigo-600 font-semibold">TU EQUIPO</span>
                                </div>
                                <input type="number" id="teamSets" min="0" max="3" value="0" 
                                    class="w-full px-4 py-3 text-center text-3xl font-bold rounded-xl border-2 border-indigo-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none bg-white"
                                    onchange="validateAndPreview()">
                            </div>
                            <span class="text-3xl font-bold text-gray-400">-</span>
                            <div class="flex-1 text-center">
                                <div class="bg-red-100 rounded-xl p-3 mb-1">
                                    <span class="text-xs text-red-600 font-semibold">RIVALES</span>
                                </div>
                                <input type="number" id="opponentSets" min="0" max="3" value="0"
                                    class="w-full px-4 py-3 text-center text-3xl font-bold rounded-xl border-2 border-red-200 focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none bg-white"
                                    onchange="validateAndPreview()">
                            </div>
                        </div>
                        <p id="scoreError" class="text-red-500 text-sm mt-2 hidden text-center"></p>
                    </div>

                    <!-- Points Preview -->
                    <div id="pointsPreview" class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-4 mb-6 hidden">
                        <h4 class="font-bold text-gray-800 mb-3 text-sm">Cambio de puntos estimado:</h4>
                        <div class="space-y-2 text-sm">
                            <div id="previewList" class="space-y-2">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-3 text-center">Se aplicar√°n cuando todos confirmen el resultado</p>
                    </div>

                    <button onclick="submitMatch()" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all">
                        Registrar Partido
                    </button>
                </div>

                <!-- Pending Confirmations -->
                <div class="glass rounded-2xl p-4 shadow-lg mt-6">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i data-lucide="clock" class="w-5 h-5 text-orange-500"></i>
                        Pendientes de Confirmar
                    </h3>
                    <div id="pendingMatches" class="space-y-3">
                        <p class="text-gray-500 text-center py-4 text-sm">No hay partidos pendientes</p>
                    </div>
                </div>
            </section>

        </div>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 glass border-t border-gray-200 z-40">
            <div class="max-w-lg mx-auto flex items-center justify-around py-2">
                <button onclick="showSection('ranking')" id="navRanking" class="nav-btn flex flex-col items-center py-2 px-4 tab-active">
                    <i data-lucide="trophy" class="w-6 h-6 mb-1"></i>
                    <span class="text-xs font-medium">Ranking</span>
                </button>
                <button onclick="showSection('addMatch')" id="navAdd" class="nav-btn flex flex-col items-center py-2 px-4 text-gray-400">
                    <div class="w-12 h-12 -mt-6 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-full flex items-center justify-center shadow-lg">
                        <i data-lucide="plus" class="w-6 h-6 text-white"></i>
                    </div>
                    <span class="text-xs font-medium mt-1">Partido</span>
                </button>
                <button onclick="showSection('profile')" id="navProfile" class="nav-btn flex flex-col items-center py-2 px-4 text-gray-400">
                    <i data-lucide="user" class="w-6 h-6 mb-1"></i>
                    <span class="text-xs font-medium">Perfil</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 hidden">
        <div class="glass-dark text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2">
            <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
            <span id="toastMessage">Operaci√≥n exitosa</span>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // ==================== DATA & STATE ====================
        const RANKS = {
            ROOKIE: { name: 'Novato', min: 0, max: 1399, class: 'rank-bronze', icon: 'üå±' },
            BRONZE: { name: 'Bronce', min: 1400, max: 1599, class: 'rank-bronze', icon: 'ü•â' },
            SILVER: { name: 'Plata', min: 1600, max: 1799, class: 'rank-silver', icon: 'ü•à' },
            GOLD: { name: 'Oro', min: 1800, max: 1999, class: 'rank-gold', icon: 'ü•á' },
            PLATINUM: { name: 'Platino', min: 2000, max: 2199, class: 'rank-platinum', icon: 'üíé' },
            DIAMOND: { name: 'Diamante', min: 2200, max: 2399, class: 'rank-diamond', icon: 'üí†' },
            LEGEND: { name: 'Leyenda', min: 2400, max: 9999, class: 'rank-legend', icon: 'üëë' }
        };

        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('rankpadel_users')) || [];
        let matches = JSON.parse(localStorage.getItem('rankpadel_matches')) || [];

        // ==================== INITIALIZATION ====================
        function init() {
            // Simulate loading
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('loading-hidden');

                if (users.length === 0) {
                    createDemoUsers();
                }

                const savedUser = localStorage.getItem('rankpadel_currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    showMainApp();
                } else {
                    document.getElementById('loginScreen').classList.remove('hidden');
                }
            }, 1000);
        }

        function createDemoUsers() {
            const demoUsers = [
                { id: 1, name: 'Carlos Garc√≠a', email: 'carlos@demo.com', password: 'demo', points: 1850, played: 12, won: 8, lost: 4 },
                { id: 2, name: 'Mar√≠a L√≥pez', email: 'maria@demo.com', password: 'demo', points: 1920, played: 15, won: 10, lost: 5 },
                { id: 3, name: 'Juan Mart√≠nez', email: 'juan@demo.com', password: 'demo', points: 1750, played: 8, won: 5, lost: 3 },
                { id: 4, name: 'Ana Rodr√≠guez', email: 'ana@demo.com', password: 'demo', points: 2100, played: 20, won: 15, lost: 5 },
                { id: 5, name: 'Pedro S√°nchez', email: 'pedro@demo.com', password: 'demo', points: 1680, played: 6, won: 3, lost: 3 },
                { id: 6, name: 'Laura Fern√°ndez', email: 'laura@demo.com', password: 'demo', points: 1890, played: 10, won: 6, lost: 4 },
                { id: 7, name: 'Diego Ruiz', email: 'diego@demo.com', password: 'demo', points: 1650, played: 7, won: 4, lost: 3 },
                { id: 8, name: 'Carmen Vega', email: 'carmen@demo.com', password: 'demo', points: 1780, played: 9, won: 5, lost: 4 }
            ];
            users = demoUsers;
            saveData();
        }

        function saveData() {
            localStorage.setItem('rankpadel_users', JSON.stringify(users));
            localStorage.setItem('rankpadel_matches', JSON.stringify(matches));
        }

        // ==================== AUTH ====================
        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function handleRegister() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            if (!name || !email || !password) {
                showToast('Completa todos los campos', 'error');
                return;
            }

            if (users.find(u => u.email === email)) {
                showToast('Email ya registrado', 'error');
                return;
            }

            const newUser = {
                id: Date.now(),
                name,
                email,
                password,
                points: 1500,
                played: 0,
                won: 0,
                lost: 0
            };

            users.push(newUser);
            saveData();

            currentUser = newUser;
            localStorage.setItem('rankpadel_currentUser', JSON.stringify(currentUser));
            showToast('¬°Bienvenido a RankPadel!');
            showMainApp();
        }

        function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const user = users.find(u => u.email === email && u.password === password);

            if (!user) {
                showToast('Credenciales incorrectas', 'error');
                return;
            }

            currentUser = user;
            localStorage.setItem('rankpadel_currentUser', JSON.stringify(currentUser));
            showToast('¬°Bienvenido de vuelta!');
            showMainApp();
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('rankpadel_currentUser');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            showLogin();
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            updateAllViews();
        }

        // ==================== NAVIGATION ====================
        function showSection(section) {
            document.getElementById('rankingSection').classList.add('hidden-section');
            document.getElementById('profileSection').classList.add('hidden-section');
            document.getElementById('addMatchSection').classList.add('hidden-section');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('text-gray-400');
            });

            if (section === 'ranking') {
                document.getElementById('rankingSection').classList.remove('hidden-section');
                document.getElementById('navRanking').classList.add('tab-active');
                document.getElementById('navRanking').classList.remove('text-gray-400');
                renderRanking();
            } else if (section === 'profile') {
                document.getElementById('profileSection').classList.remove('hidden-section');
                document.getElementById('navProfile').classList.add('tab-active');
                document.getElementById('navProfile').classList.remove('text-gray-400');
                renderProfile();
            } else if (section === 'addMatch') {
                document.getElementById('addMatchSection').classList.remove('hidden-section');
                document.getElementById('navAdd').classList.add('tab-active');
                document.getElementById('navAdd').classList.remove('text-gray-400');
                renderAddMatch();
            }

            lucide.createIcons();
        }

        // ==================== RANKING SYSTEM ====================
        function getRank(points) {
            for (const [key, rank] of Object.entries(RANKS)) {
                if (points >= rank.min && points <= rank.max) {
                    return { ...rank, key };
                }
            }
            return RANKS.ROOKIE;
        }

        function calculateTeamEloChange(team1Players, team2Players, team1Won) {
            const team1Avg = team1Players.reduce((sum, p) => sum + p.points, 0) / team1Players.length;
            const team2Avg = team2Players.reduce((sum, p) => sum + p.points, 0) / team2Players.length;

            const K = 32;
            const expectedScore = 1 / (1 + Math.pow(10, (team2Avg - team1Avg) / 400));
            const actualScore = team1Won ? 1 : 0;
            const teamChange = Math.round(K * (actualScore - expectedScore));

            const changes = [];

            team1Players.forEach(player => {
                const weight = 1 + ((team1Avg - player.points) / 2000);
                const playerChange = Math.round(teamChange * weight);
                changes.push({ playerId: player.id, change: playerChange });
            });

            team2Players.forEach(player => {
                const weight = 1 + ((team2Avg - player.points) / 2000);
                const playerChange = Math.round(-teamChange * weight);
                changes.push({ playerId: player.id, change: playerChange });
            });

            return changes;
        }

        function getNextLevelInfo(points) {
            const currentRank = getRank(points);
            const ranks = Object.values(RANKS);
            const currentIndex = ranks.findIndex(r => r.name === currentRank.name);

            if (currentIndex === ranks.length - 1) {
                return { nextRank: null, progress: 100, needed: 0 };
            }

            const nextRank = ranks[currentIndex + 1];
            const range = nextRank.min - currentRank.min;
            const progress = ((points - currentRank.min) / range) * 100;
            const needed = nextRank.min - points;

            return { nextRank, progress: Math.min(progress, 100), needed };
        }

        // ==================== RENDERING ====================
        function renderRanking() {
            const sortedUsers = [...users].sort((a, b) => b.points - a.points);
            document.getElementById('totalPlayers').textContent = `${sortedUsers.length} jugadores`;

            const podiumHTML = sortedUsers.slice(0, 3).map((user, index) => {
                const rank = getRank(user.points);
                const positions = ['second', 'first', 'third'];
                const heights = ['h-24', 'h-32', 'h-20'];
                const actualIndex = index === 0 ? 1 : index === 1 ? 0 : 2;

                return `
                    <div class="flex flex-col items-center ${positions[actualIndex] === 'first' ? 'order-2' : positions[actualIndex] === 'second' ? 'order-1' : 'order-3'}">
                        <div class="relative mb-2">
                            <div class="w-16 h-16 rounded-full ${rank.class} flex items-center justify-center text-2xl border-4 border-white shadow-lg">
                                ${user.name.charAt(0)}
                            </div>
                            <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-6 h-6 rounded-full bg-white flex items-center justify-center text-sm font-bold shadow-md">
                                ${actualIndex === 0 ? 'ü•à' : actualIndex === 1 ? 'ü•á' : 'ü•â'}
                            </div>
                        </div>
                        <div class="text-white text-center">
                            <p class="font-bold text-sm truncate w-20">${user.name.split(' ')[0]}</p>
                            <p class="text-xs opacity-90">${user.points} pts</p>
                        </div>
                        <div class="${heights[actualIndex]} w-16 ${rank.class} rounded-t-lg mt-2 opacity-80"></div>
                    </div>
                `;
            }).join('');

            document.getElementById('podiumContainer').innerHTML = podiumHTML;

            const listHTML = sortedUsers.map((user, index) => {
                const rank = getRank(user.points);
                const isCurrentUser = user.id === currentUser.id;

                return `
                    <div class="flex items-center gap-3 p-3 rounded-xl ${isCurrentUser ? 'bg-indigo-50 border border-indigo-200' : 'bg-gray-50'} hover:bg-gray-100 transition-colors">
                        <div class="w-8 text-center font-bold text-gray-500">${index + 1}</div>
                        <div class="w-10 h-10 rounded-full ${rank.class} flex items-center justify-center text-white font-bold text-sm">
                            ${user.name.charAt(0)}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="font-semibold text-gray-800 ${isCurrentUser ? 'text-indigo-700' : ''}">${user.name}</span>
                                ${isCurrentUser ? '<span class="text-xs bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full">T√∫</span>' : ''}
                            </div>
                            <div class="flex items-center gap-2 text-xs text-gray-500">
                                <span>${rank.icon} ${rank.name}</span>
                                <span>‚Ä¢</span>
                                <span>${user.played} partidos</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-gray-800">${user.points}</div>
                            <div class="text-xs text-gray-400">puntos</div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('rankingList').innerHTML = listHTML;
        }

        function renderProfile() {
            const user = users.find(u => u.id === currentUser.id);
            currentUser = user;

            const rank = getRank(user.points);
            const nextLevel = getNextLevelInfo(user.points);

            document.getElementById('profileName').textContent = user.name;
            document.getElementById('profileLevel').textContent = `Nivel ${rank.name}`;
            document.getElementById('profilePoints').textContent = user.points;
            document.getElementById('profileLevelBadge').textContent = rank.icon;
            document.getElementById('profileLevelBadge').className = `w-20 h-20 rounded-2xl flex items-center justify-center text-2xl font-bold text-white shadow-lg level-badge ${rank.class}`;

            document.getElementById('statPlayed').textContent = user.played;
            document.getElementById('statWon').textContent = user.won;
            document.getElementById('statLost').textContent = user.lost;

            const winRate = user.played > 0 ? Math.round((user.won / user.played) * 100) : 0;
            document.getElementById('winRate').textContent = `${winRate}%`;
            document.getElementById('winRateBar').style.width = `${winRate}%`;

            document.getElementById('nextLevelProgress').textContent = `${Math.round(nextLevel.progress)}%`;
            document.getElementById('levelProgressBar').style.width = `${nextLevel.progress}%`;

            if (nextLevel.nextRank) {
                document.getElementById('nextLevelText').textContent = `${nextLevel.needed} puntos para ${nextLevel.nextRank.name}`;
            } else {
                document.getElementById('nextLevelText').textContent = '¬°Has alcanzado el nivel m√°ximo!';
            }

            const userMatches = matches.filter(m => {
                const allPlayers = [m.team1Player1Id, m.team1Player2Id, m.team2Player1Id, m.team2Player2Id];
                return allPlayers.includes(user.id) && m.status === 'confirmed';
            }).sort((a, b) => b.date - a.date).slice(0, 5);

            if (userMatches.length > 0) {
                document.getElementById('recentMatches').innerHTML = userMatches.map(match => {
                    const isTeam1 = match.team1Player1Id === user.id || match.team1Player2Id === user.id;
                    const won = (isTeam1 && match.winner === 'team1') || (!isTeam1 && match.winner === 'team2');
                    const score = isTeam1 ? 
                        `${match.team1Sets}-${match.team2Sets}` : 
                        `${match.team2Sets}-${match.team1Sets}`;

                    const opponent1 = users.find(u => u.id === match.team2Player1Id);
                    const opponent2 = users.find(u => u.id === match.team2Player2Id);

                    const myChange = match.changes.find(c => c.playerId === user.id);
                    const pointsChange = myChange ? myChange.change : 0;

                    return `
                        <div class="match-card flex items-center justify-between p-3 bg-gray-50 rounded-xl ${won ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500'}">
                            <div class="flex-1">
                                <div class="flex items-center gap-1 mb-1">
                                    <span class="text-xs font-semibold ${won ? 'text-green-600' : 'text-red-600'}">${won ? 'Victoria' : 'Derrota'}</span>
                                    <span class="text-xs text-gray-400">‚Ä¢ ${new Date(match.date).toLocaleDateString()}</span>
                                </div>
                                <p class="text-xs text-gray-600">vs ${opponent1.name.split(' ')[0]} & ${opponent2.name.split(' ')[0]}</p>
                            </div>
                            <div class="text-right">
                                <div class="font-bold ${won ? 'text-green-600' : 'text-red-600'}">${score}</div>
                                <div class="text-xs ${pointsChange > 0 ? 'text-green-500' : pointsChange < 0 ? 'text-red-500' : 'text-gray-400'}">
                                    ${pointsChange > 0 ? '+' : ''}${pointsChange} pts
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                document.getElementById('recentMatches').innerHTML = '<p class="text-gray-500 text-center py-4">No hay partidos registrados</p>';
            }
        }

        function renderAddMatch() {
            // Update current user display
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('currentUserPoints').textContent = `(${currentUser.points} pts)`;

            const otherUsers = users.filter(u => u.id !== currentUser.id);

            const partnerSelect = document.getElementById('partnerSelect');
            partnerSelect.innerHTML = '<option value="">Selecciona tu compa√±ero...</option>';
            otherUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.points} pts)`;
                partnerSelect.appendChild(option);
            });

            const opponent1Select = document.getElementById('opponent1Select');
            opponent1Select.innerHTML = '<option value="">Rival 1...</option>';
            otherUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.points} pts)`;
                opponent1Select.appendChild(option);
            });

            const opponent2Select = document.getElementById('opponent2Select');
            opponent2Select.innerHTML = '<option value="">Rival 2...</option>';
            otherUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.points} pts)`;
                opponent2Select.appendChild(option);
            });

            opponent1Select.onchange = function() {
                updateOpponentOptions();
                validateAndPreview();
            };
            partnerSelect.onchange = function() {
                updateOpponentOptions();
                validateAndPreview();
            };
            opponent2Select.onchange = validateAndPreview;

            const pending = matches.filter(m => {
                if (m.status !== 'pending') return false;
                const allPlayers = [m.team1Player1Id, m.team1Player2Id, m.team2Player1Id, m.team2Player2Id];
                return allPlayers.includes(currentUser.id);
            });

            if (pending.length > 0) {
                document.getElementById('pendingMatches').innerHTML = pending.map(match => {
                    const isTeam1 = match.team1Player1Id === currentUser.id || match.team1Player2Id === currentUser.id;
                    const otherTeam = isTeam1 ? 'team2' : 'team1';
                    const otherPlayer1 = users.find(u => u.id === match[`${otherTeam}Player1Id`]);
                    const otherPlayer2 = users.find(u => u.id === match[`${otherTeam}Player2Id`]);

                    const myTeammateId = isTeam1 ? 
                        (match.team1Player1Id === currentUser.id ? match.team1Player2Id : match.team1Player1Id) :
                        (match.team2Player1Id === currentUser.id ? match.team2Player2Id : match.team2Player1Id);
                    const myTeammate = users.find(u => u.id === myTeammateId);

                    const score = isTeam1 ? 
                        `${match.team1Sets}-${match.team2Sets}` : 
                        `${match.team2Sets}-${match.team1Sets}`;

                    return `
                        <div class="bg-orange-50 border border-orange-200 rounded-xl p-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-gray-500">Partido registrado por:</span>
                                <span class="text-xs text-orange-600 bg-orange-100 px-2 py-1 rounded-full">Pendiente</span>
                            </div>
                            <div class="text-sm mb-2">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">T√∫ & ${myTeammate.name.split(' ')[0]}</span>
                                    <span class="font-bold">${score}</span>
                                    <span class="font-medium">${otherPlayer1.name.split(' ')[0]} & ${otherPlayer2.name.split(' ')[0]}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="confirmMatch(${match.id}, true)" class="flex-1 py-2 bg-green-500 text-white rounded-lg text-sm font-medium hover:bg-green-600 transition-colors">
                                    Confirmar
                                </button>
                                <button onclick="confirmMatch(${match.id}, false)" class="flex-1 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition-colors">
                                    Rechazar
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                document.getElementById('pendingMatches').innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">No hay partidos pendientes</p>';
            }
        }

        function updateOpponentOptions() {
            const partnerId = document.getElementById('partnerSelect').value;
            const opponent1Id = document.getElementById('opponent1Select').value;

            const opponent2Select = document.getElementById('opponent2Select');
            const currentVal = opponent2Select.value;

            opponent2Select.innerHTML = '<option value="">Rival 2...</option>';

            users.filter(u => 
                u.id !== currentUser.id && 
                u.id != partnerId && 
                u.id != opponent1Id
            ).forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.points} pts)`;
                if (user.id == currentVal) option.selected = true;
                opponent2Select.appendChild(option);
            });
        }

        function validateAndPreview() {
            const partnerId = document.getElementById('partnerSelect').value;
            const opponent1Id = document.getElementById('opponent1Select').value;
            const opponent2Id = document.getElementById('opponent2Select').value;
            const teamSets = parseInt(document.getElementById('teamSets').value) || 0;
            const opponentSets = parseInt(document.getElementById('opponentSets').value) || 0;

            const errorEl = document.getElementById('scoreError');
            const previewEl = document.getElementById('pointsPreview');

            const selectedIds = [currentUser.id, parseInt(partnerId), parseInt(opponent1Id), parseInt(opponent2Id)];
            if (new Set(selectedIds).size !== 4) {
                errorEl.textContent = 'No puede haber jugadores repetidos';
                errorEl.classList.remove('hidden');
                previewEl.classList.add('hidden');
                return false;
            }

            if (!partnerId || !opponent1Id || !opponent2Id) {
                errorEl.classList.add('hidden');
                previewEl.classList.add('hidden');
                return false;
            }

            if (teamSets === opponentSets) {
                errorEl.textContent = 'No puede haber empate';
                errorEl.classList.remove('hidden');
                previewEl.classList.add('hidden');
                return false;
            }

            if (teamSets < 0 || opponentSets < 0 || teamSets > 3 || opponentSets > 3) {
                errorEl.textContent = 'Sets inv√°lidos (m√°x 3)';
                errorEl.classList.remove('hidden');
                previewEl.classList.add('hidden');
                return false;
            }

            if ((teamSets === 3 && opponentSets > 1) || (opponentSets === 3 && teamSets > 1)) {
                errorEl.textContent = 'Resultado imposible (mejor de 5)';
                errorEl.classList.remove('hidden');
                previewEl.classList.add('hidden');
                return false;
            }

            errorEl.classList.add('hidden');

            const partner = users.find(u => u.id === parseInt(partnerId));
            const opponent1 = users.find(u => u.id === parseInt(opponent1Id));
            const opponent2 = users.find(u => u.id === parseInt(opponent2Id));

            const team1Players = [currentUser, partner];
            const team2Players = [opponent1, opponent2];
            const team1Won = teamSets > opponentSets;

            const changes = calculateTeamEloChange(team1Players, team2Players, team1Won);

            let previewHTML = '';
            changes.forEach(change => {
                const player = users.find(u => u.id === change.playerId);
                const isPositive = change.change > 0;
                const colorClass = isPositive ? 'text-green-600' : change.change < 0 ? 'text-red-600' : 'text-gray-600';
                const sign = isPositive ? '+' : '';

                previewHTML += `
                    <div class="flex items-center justify-between p-2 bg-white rounded-lg">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold">
                                ${player.name.charAt(0)}
                            </div>
                            <span class="font-medium">${player.name.split(' ')[0]}</span>
                        </div>
                        <span class="font-bold ${colorClass}">${sign}${change.change} pts</span>
                    </div>
                `;
            });

            document.getElementById('previewList').innerHTML = previewHTML;
            previewEl.classList.remove('hidden');

            return true;
        }

        function submitMatch() {
            if (!validateAndPreview()) return;

            const partnerId = parseInt(document.getElementById('partnerSelect').value);
            const opponent1Id = parseInt(document.getElementById('opponent1Select').value);
            const opponent2Id = parseInt(document.getElementById('opponent2Select').value);
            const teamSets = parseInt(document.getElementById('teamSets').value);
            const opponentSets = parseInt(document.getElementById('opponentSets').value);

            const newMatch = {
                id: Date.now(),
                team1Player1Id: currentUser.id,
                team1Player2Id: partnerId,
                team2Player1Id: opponent1Id,
                team2Player2Id: opponent2Id,
                team1Sets: teamSets,
                team2Sets: opponentSets,
                winner: teamSets > opponentSets ? 'team1' : 'team2',
                mode: 'double',
                status: 'pending',
                date: Date.now(),
                changes: [],
                confirmedBy: [currentUser.id]
            };

            matches.push(newMatch);
            saveData();

            showToast('Partido registrado. Esperando confirmaciones.');

            document.getElementById('partnerSelect').value = '';
            document.getElementById('opponent1Select').value = '';
            document.getElementById('opponent2Select').value = '';
            document.getElementById('teamSets').value = '0';
            document.getElementById('opponentSets').value = '0';
            document.getElementById('pointsPreview').classList.add('hidden');

            renderAddMatch();
        }

        function confirmMatch(matchId, accept) {
            const match = matches.find(m => m.id === matchId);
            if (!match) return;

            if (!match.confirmedBy.includes(currentUser.id)) {
                match.confirmedBy.push(currentUser.id);
            }

            if (accept) {
                if (match.confirmedBy.length >= 4) {
                    const team1Players = [
                        users.find(u => u.id === match.team1Player1Id),
                        users.find(u => u.id === match.team1Player2Id)
                    ];
                    const team2Players = [
                        users.find(u => u.id === match.team2Player1Id),
                        users.find(u => u.id === match.team2Player2Id)
                    ];

                    const team1Won = match.winner === 'team1';
                    const changes = calculateTeamEloChange(team1Players, team2Players, team1Won);

                    changes.forEach(change => {
                        const player = users.find(u => u.id === change.playerId);
                        player.points += change.change;
                        player.played += 1;

                        const playerWon = (team1Won && (player.id === match.team1Player1Id || player.id === match.team1Player2Id)) ||
                                         (!team1Won && (player.id === match.team2Player1Id || player.id === match.team2Player2Id));

                        if (playerWon) player.won += 1;
                        else player.lost += 1;
                    });

                    match.changes = changes;
                    match.status = 'confirmed';

                    saveData();
                    showToast('¬°Partido confirmado! Puntos actualizados');

                    currentUser = users.find(u => u.id === currentUser.id);
                    localStorage.setItem('rankpadel_currentUser', JSON.stringify(currentUser));
                } else {
                    saveData();
                    showToast(`Confirmaci√≥n registrada (${match.confirmedBy.length}/4)`);
                }
            } else {
                match.status = 'rejected';
                saveData();
                showToast('Partido rechazado');
            }

            renderAddMatch();
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function updateAllViews() {
            renderRanking();
            renderProfile();
            renderAddMatch();
        }

        // Start app
        init();
    </script>
</body>
</html>